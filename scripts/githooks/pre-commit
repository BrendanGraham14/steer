#!/usr/bin/env bash

# Git pre-commit hook: fix issues and run the full test suite
# Requires: just (https://github.com/casey/just)
set -euo pipefail

echo "Running pre-commit checks..."

# Check if just is installed
if ! command -v just &> /dev/null; then
    echo "✗ Error: 'just' command not found"
    echo "Please install just: https://github.com/casey/just#installation"
    exit 1
fi

# Get list of staged files before any modifications
STAGED_FILES=$(git diff --staged --name-only)

# Stash any unstaged changes to avoid conflicts with --allow-staged
STASH_NAME="pre-commit-hook-$(date +%s)"
STASHED=false

# Check if there are any unstaged changes
if ! git diff --quiet || ! git diff --quiet; then
    echo "Stashing unstaged changes..."
    git stash push --keep-index --include-untracked -m "$STASH_NAME"
    STASHED=true
fi

# Function to restore stashed changes
restore_stash() {
    if [ "$STASHED" = true ]; then
        echo "Restoring unstaged changes..."
        git stash pop --quiet || {
            echo "⚠️  Failed to restore stashed changes automatically."
            echo "Your changes are saved in the stash. Run 'git stash list' to see them."
        }
    fi
}

# Ensure we restore the stash on exit
trap restore_stash EXIT

# Run just fix to fix compiler warnings, clippy warnings, and formatting
echo "Running: just fix"
if just fix; then
    echo "✓ just fix completed (cargo fix, clippy, fmt)"
else
    echo "✗ just fix failed"
    exit 1
fi

# Check if any of the staged files were modified by the fixes
MODIFIED=false
for file in $STAGED_FILES; do
    if ! git diff --quiet "$file" 2>/dev/null; then
        MODIFIED=true
        break
    fi
done

if [ "$MODIFIED" = true ]; then
    echo "✗ Staged files were modified by cargo fix/clippy/fmt."
    echo "Please review the changes and commit them manually."
    echo "Modified staged files:"
    for file in $STAGED_FILES; do
        if ! git diff --quiet "$file" 2>/dev/null; then
            echo "  - $file"
        fi
    done
    echo "You can see the changes with: git diff --staged"
    exit 1
fi

# Run tests
echo "Running: just test"
if just test; then
    echo "✓ All tests passed"
else
    echo "✗ Tests failed"
    exit 1
fi

echo "✓ Pre-commit checks completed successfully"
